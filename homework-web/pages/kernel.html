<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内核核心模块 - Linux 系统编程</title>
    <link rel="stylesheet" href="../css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo">🐧</span>
            <span class="title">Linux 系统编程</span>
        </div>
        <ul class="nav-links">
            <li><a href="../index.html">首页</a></li>
            <li><a href="linux-env.html">Linux环境</a></li>
            <li><a href="architecture.html">系统架构</a></li>
            <li><a href="c-programming.html">C语言</a></li>
            <li><a href="kernel.html" class="active">内核模块</a></li>
            <li><a href="android.html">安卓</a></li>
            <li><a href="quiz.html">测验</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="page-container">
            <header class="page-header">
                <h1><span class="icon">⚙️</span> 内核核心模块</h1>
                <p class="breadcrumb"><a href="../index.html">首页</a> / 内核核心模块</p>
            </header>

            <!-- 进程管理 -->
            <section class="content-section" id="process-management">
                <h2 class="section-title">
                    <span class="icon">📊</span>
                    4.1 进程管理
                </h2>

                <div class="info-box">
                    <h4>什么是进程管理？</h4>
                    <p>进程管理负责进程的<strong>创建、调度、切换、终止</strong>，是内核最核心的功能之一。</p>
                </div>

                <div class="diagram-container">
                    <h4>进程内存布局</h4>
                    <div class="arch-diagram">
                        <div class="arch-layer" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            📚 Stack（栈）↓
                            <div style="font-size: 0.8rem; font-weight: normal;">局部变量、函数调用、返回地址</div>
                        </div>
                        <div style="text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                            ↓ 向下增长 ┃ 向上增长 ↑
                        </div>
                        <div class="arch-layer" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            🧱 Heap（堆）↑
                            <div style="font-size: 0.8rem; font-weight: normal;">malloc/realloc 动态分配</div>
                        </div>
                        <div class="arch-layer" style="background: linear-gradient(135deg, #64748b, #475569);">
                            📦 BSS / Data
                            <div style="font-size: 0.8rem; font-weight: normal;">全局变量、静态变量</div>
                        </div>
                        <div class="arch-layer" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            📝 Text（代码段）
                            <div style="font-size: 0.8rem; font-weight: normal;">程序指令（只读）</div>
                        </div>
                    </div>
                </div>

                <div class="diagram-container">
                    <h4>进程状态转换</h4>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <span class="num">1</span>
                            <div>创建</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">fork()</div>
                        </div>
                        <span class="flow-arrow">→</span>
                        <div class="flow-step highlight">
                            <div>就绪</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">等待CPU</div>
                        </div>
                        <span class="flow-arrow">↔</span>
                        <div class="flow-step" style="border-color: var(--success-color);">
                            <span class="num">2</span>
                            <div>运行</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">执行中</div>
                        </div>
                        <span class="flow-arrow">↓</span>
                        <div class="flow-step" style="border-color: var(--warning-color);">
                            <div>等待</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">I/O等待</div>
                        </div>
                        <span class="flow-arrow">→</span>
                        <div class="flow-step" style="border-color: var(--danger-color);">
                            <span class="num">3</span>
                            <div>终止</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">exit()</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>系统调用</th>
                                <th>作用</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>fork()</code></td>
                                <td>创建进程</td>
                                <td>复制当前进程，创建子进程</td>
                            </tr>
                            <tr>
                                <td><code>exec()</code></td>
                                <td>加载程序</td>
                                <td>用新程序替换当前进程</td>
                            </tr>
                            <tr>
                                <td><code>wait()</code></td>
                                <td>等待子进程</td>
                                <td>阻塞直到子进程结束</td>
                            </tr>
                            <tr>
                                <td><code>exit()</code></td>
                                <td>终止进程</td>
                                <td>结束当前进程</td>
                            </tr>
                            <tr>
                                <td><code>getpid()</code></td>
                                <td>获取 PID</td>
                                <td>返回当前进程 ID</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 内存管理 -->
            <section class="content-section" id="memory-management">
                <h2 class="section-title">
                    <span class="icon">🧠</span>
                    4.2 内存管理
                </h2>

                <div class="card-grid">
                    <div class="feature-card">
                        <div class="icon">💾</div>
                        <h4>物理内存</h4>
                        <p>实际的 RAM 芯片</p>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                            <li>有限的硬件资源</li>
                            <li>直接访问受限制</li>
                            <li>由内核统一管理</li>
                        </ul>
                    </div>
                    <div class="feature-card" style="border-color: var(--primary-color);">
                        <div class="icon">🌐</div>
                        <h4>虚拟内存</h4>
                        <p>抽象的地址空间</p>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                            <li>每个进程独立</li>
                            <li>可超过物理内存</li>
                            <li>通过 MMU 转换</li>
                        </ul>
                    </div>
                </div>

                <div class="diagram-container">
                    <h4>虚拟内存工作原理</h4>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); border: 2px solid var(--primary-color);">
                                <div style="font-weight: bold; color: var(--primary-color);">虚拟地址</div>
                                <div style="font-family: monospace; margin-top: 0.5rem;">Page 5</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem;">→</div>
                            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-sm); font-size: 0.9rem;">MMU 转换</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); border: 2px solid var(--success-color);">
                                <div style="font-weight: bold; color: var(--success-color);">物理地址</div>
                                <div style="font-family: monospace; margin-top: 0.5rem;">Frame 12</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>概念</th>
                                <th>说明</th>
                                <th>典型大小</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Page（页）</strong></td>
                                <td>虚拟内存的固定大小块</td>
                                <td>4KB</td>
                            </tr>
                            <tr>
                                <td><strong>Frame（帧）</strong></td>
                                <td>物理内存的固定大小块</td>
                                <td>4KB（与页相同）</td>
                            </tr>
                            <tr>
                                <td><strong>Page Table（页表）</strong></td>
                                <td>页到帧的映射表</td>
                                <td>内核维护</td>
                            </tr>
                            <tr>
                                <td><strong>MMU</strong></td>
                                <td>内存管理单元（硬件）</td>
                                <td>CPU 组件</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="warning-box">
                    <h4>⚠️ 缺页异常 (Page Fault)</h4>
                    <p>当进程访问的虚拟页不在物理内存时，触发缺页异常：</p>
                    <ol style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>MMU 发现页不在内存</li>
                        <li>触发异常，陷入内核</li>
                        <li>内核从磁盘加载页</li>
                        <li>更新页表</li>
                        <li>重新执行指令</li>
                    </ol>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span>内存分配 API</span>
                        <button class="copy-btn">复制</button>
                    </div>
                    <pre><code>// 堆内存分配
void *ptr = malloc(size);      // 分配内存
ptr = realloc(ptr, newsize);   // 重新分配
free(ptr);                      // 释放内存

// 内存映射
void *map = mmap(NULL, size, 
                 PROT_READ | PROT_WRITE,
                 MAP_SHARED | MAP_ANONYMOUS, 
                 -1, 0);
munmap(map, size);             // 解除映射</code></pre>
                </div>
            </section>

            <!-- 文件系统 -->
            <section class="content-section" id="filesystem">
                <h2 class="section-title">
                    <span class="icon">📁</span>
                    4.3 文件系统
                </h2>

                <div class="diagram-container">
                    <h4>文件系统层次结构</h4>
                    <div class="arch-diagram">
                        <div class="arch-layer app-layer">
                            📂 文件路径
                            <div style="font-size: 0.8rem; font-weight: normal;">/home/user/file.txt</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer lib-layer">
                            📋 目录结构
                            <div style="font-size: 0.8rem; font-weight: normal;">文件名 → Inode 映射</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer kernel-layer">
                            🔢 Inode
                            <div style="font-size: 0.8rem; font-weight: normal;">元数据（权限、大小、数据块位置）</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer hw-layer">
                            💾 数据块
                            <div style="font-size: 0.8rem; font-weight: normal;">实际文件内容</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Inode 包含</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>文件大小</td><td>字节数</td></tr>
                            <tr><td>权限</td><td>rwx 权限位</td></tr>
                            <tr><td>时间戳</td><td>创建、修改、访问时间</td></tr>
                            <tr><td>数据块位置</td><td>文件内容在磁盘的位置</td></tr>
                            <tr><td>链接数</td><td>硬链接数量</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="diagram-container">
                    <h4>Linux 目录结构</h4>
                    <div style="font-family: monospace; font-size: 0.9rem;">
                        <div style="color: var(--primary-color);">/</div>
                        <div style="padding-left: 1rem;">
                            <div>├── <span style="color: var(--success-color);">bin/</span> 基本命令</div>
                            <div>├── <span style="color: var(--success-color);">etc/</span> 配置文件</div>
                            <div>├── <span style="color: var(--success-color);">home/</span> 用户主目录</div>
                            <div>├── <span style="color: var(--success-color);">lib/</span> 库文件</div>
                            <div>├── <span style="color: var(--success-color);">tmp/</span> 临时文件</div>
                            <div>├── <span style="color: var(--success-color);">usr/</span> 用户程序</div>
                            <div>├── <span style="color: var(--success-color);">var/</span> 可变数据</div>
                            <div>└── <span style="color: var(--success-color);">proc/</span> 进程信息（虚拟）</div>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span>文件操作</span>
                        <button class="copy-btn">复制</button>
                    </div>
                    <pre><code>int fd = open("file.txt", O_RDWR);  // 打开
write(fd, "data", 4);               // 写入
lseek(fd, 0, SEEK_SET);            // 定位
read(fd, buffer, 100);              // 读取
close(fd);                          // 关闭</code></pre>
                </div>
            </section>

            <!-- 设备驱动 -->
            <section class="content-section" id="drivers">
                <h2 class="section-title">
                    <span class="icon">🔧</span>
                    4.4 设备驱动
                </h2>

                <div class="info-box">
                    <h4>设备驱动的作用</h4>
                    <p>设备驱动是<strong>内核和硬件之间的桥梁</strong>，将硬件操作抽象为统一的接口。</p>
                </div>

                <div class="card-grid">
                    <div class="feature-card">
                        <div class="icon">⌨️</div>
                        <h4>字符设备</h4>
                        <p>按字节流访问</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">键盘、鼠标、串口</p>
                    </div>
                    <div class="feature-card">
                        <div class="icon">💾</div>
                        <h4>块设备</h4>
                        <p>按块访问</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">硬盘、U盘、SSD</p>
                    </div>
                    <div class="feature-card">
                        <div class="icon">🌐</div>
                        <h4>网络设备</h4>
                        <p>网络通信</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">网卡、无线适配器</p>
                    </div>
                </div>

                <div class="diagram-container">
                    <h4>一切皆文件</h4>
                    <div class="code-block" style="margin: 0; border: none;">
                        <pre><code>/dev/null     # 空设备，丢弃所有写入
/dev/zero     # 零设备，读取返回 0
/dev/random   # 随机数设备
/dev/tty      # 当前终端
/dev/sda      # 第一块硬盘</code></pre>
                    </div>
                </div>
            </section>

            <!-- 网络子系统 -->
            <section class="content-section" id="network">
                <h2 class="section-title">
                    <span class="icon">🌐</span>
                    4.5 网络子系统
                </h2>

                <div class="diagram-container">
                    <h4>数据包从网卡到程序的流程</h4>
                    <div class="arch-diagram">
                        <div class="arch-layer hw-layer">
                            🌐 网络数据包
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer" style="background: linear-gradient(135deg, #10b981, #059669);">
                            🔌 网卡 (NIC)
                            <div style="font-size: 0.8rem; font-weight: normal;">接收数据，触发中断</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer kernel-layer">
                            📦 内核网络驱动
                            <div style="font-size: 0.8rem; font-weight: normal;">处理中断，放入缓冲区</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            🔗 网络协议栈
                            <div style="font-size: 0.8rem; font-weight: normal;">以太网 → IP → TCP/UDP</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer lib-layer">
                            📬 Socket 缓冲区
                            <div style="font-size: 0.8rem; font-weight: normal;">按连接分发数据</div>
                        </div>
                        <div class="arch-arrow">↓</div>
                        <div class="arch-layer app-layer">
                            🖥️ 用户程序
                            <div style="font-size: 0.8rem; font-weight: normal;">read()/recv() 读取</div>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span>Socket 编程示例</span>
                        <button class="copy-btn">复制</button>
                    </div>
                    <pre><code>// 服务器端
int server = socket(AF_INET, SOCK_STREAM, 0);
bind(server, (struct sockaddr*)&addr, sizeof(addr));
listen(server, 5);
int client = accept(server, NULL, NULL);
recv(client, buffer, sizeof(buffer), 0);
send(client, "Response", 8, 0);

// 客户端
int sock = socket(AF_INET, SOCK_STREAM, 0);
connect(sock, (struct sockaddr*)&addr, sizeof(addr));
send(sock, "Request", 7, 0);
recv(sock, buffer, sizeof(buffer), 0);</code></pre>
                </div>
            </section>

            <!-- 核心总结 -->
            <section class="content-section" id="summary">
                <h2 class="section-title">
                    <span class="icon">📌</span>
                    核心总结
                </h2>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>模块</th>
                                <th>干嘛的</th>
                                <th>所在层级</th>
                                <th>和上层交互</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>进程管理</strong></td>
                                <td>创建、调度、终止进程</td>
                                <td>内核层</td>
                                <td>fork/exec/wait 系统调用</td>
                            </tr>
                            <tr>
                                <td><strong>内存管理</strong></td>
                                <td>分配、映射、保护内存</td>
                                <td>内核层</td>
                                <td>malloc/mmap 系统调用</td>
                            </tr>
                            <tr>
                                <td><strong>文件系统</strong></td>
                                <td>组织、存储、读取文件</td>
                                <td>内核层</td>
                                <td>open/read/write 系统调用</td>
                            </tr>
                            <tr>
                                <td><strong>设备驱动</strong></td>
                                <td>控制硬件设备</td>
                                <td>内核层</td>
                                <td>通过 /dev 设备文件</td>
                            </tr>
                            <tr>
                                <td><strong>网络子系统</strong></td>
                                <td>处理网络通信</td>
                                <td>内核层</td>
                                <td>socket 系统调用</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 完成按钮 -->
            <div class="completion-section" style="text-align: center; margin: 3rem 0; padding: 2rem; background: var(--bg-secondary); border-radius: var(--radius-xl);">
                <h3 style="margin-bottom: 1rem;">🎉 完成本模块学习？</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">点击按钮保存学习进度</p>
                <button onclick="markCompleted('kernel')" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 1rem 2rem; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 600; cursor: pointer;">
                    ✓ 标记为已完成
                </button>
            </div>

            <!-- 导航按钮 -->
            <div class="nav-buttons">
                <a href="c-programming.html" class="nav-btn">
                    ← 上一章：C 语言
                </a>
                <a href="android.html" class="nav-btn next">
                    下一章：安卓与 Linux →
                </a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Linux 系统编程学习指南</p>
    </footer>

    <script src="../js/main.js"></script>
</body>
</html>
